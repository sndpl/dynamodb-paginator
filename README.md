![npm](https://img.shields.io/npm/v/dynamodb-paginator.svg)
![NPM](https://img.shields.io/npm/l/dynamodb-paginator.svg)
![David](https://img.shields.io/david/supersoniko/dynamodb-paginator.svg)
![CircleCI](https://img.shields.io/circleci/build/github/supersoniko/dynamodb-paginator.svg)
[![codecov](https://codecov.io/gh/supersoniko/dynamodb-paginator/branch/master/graph/badge.svg)](https://codecov.io/gh/supersoniko/dynamodb-paginator)

Implementation of pagination for DynamoDB from the following article: https://hackernoon.com/guys-were-doing-pagination-wrong-f6c18a91b232

**NOTE**: This pagination library only works on indexes with a range key.

# Usage

```typescript
import {DocumentClient} from 'aws-sdk/clients/dynamodb';
import {getPaginatedResult, decodeCursor} from 'dynamodb-paginator';

interface User {
    id: string
}

const documentClient = new DocumentClient();

const limit = 25;
const standardQueryParams = {
    TableName: 'Users',
    Limit: limit,
    KeyConditionExpression: 'id = :id',
    ExpressionAttributeValues: {
        ':id': '1'
    }
}
// Could be a cursor from a previous paginated result
const cursor = undefined

// As of version 2.x.x this does not return the whole query params object
const paginationParams = decodeCursor(cursor) || {}
const queryParams = {...standardQueryParams, ...paginationParams}

const result = await documentClient.query(queryParams).promise();
const paginatedResult = getPaginatedResult<User>(params, limit, result);
```

## Security disclaimer
It's important to validate that the cursor has been generated by your service before passing it to the DynamoDB. If you don't, this opens a NoSQL vulnerability.
A solution for this is signing/encrypting the cursor with a key. 

Without encrypting the cursor, the partition and range key are also visible to the client consuming the cursor.

If your service offers authentication, it's also wise to validate that the cursor being parsed, was originally generated for that user/session. This is to prevent replay attacks.

### Cursor encryption example
A simplified example of encrypting and decrypting the generated pagination cursor using [sodium-plus](https://www.npmjs.com/package/sodium-plus).

It's recommended to encapsulate the secured pagination code in a service, for ease of use.

```javascript
import { SodiumPlus } from 'sodium-plus';
import { getPaginatedResult, decodeCursor } from 'dynamodb-paginator';

const params = { TableName: 'Users' };
const limit = 25;
// Example DynamoDB Output
const result = {
    Items:
        [
            { id: 1, email: 'a@example.com' },
            { id: 2, email: 'b@example.com' },
        ],
    Count: 2,
    LastEvaluatedKey: { id: 2 },
};

// Simplified encryption example (without back cursor encryption)
(async function() {
    const sodium = await SodiumPlus.auto();

    const key = await sodium.crypto_secretbox_keygen();
    const nonce = await sodium.randombytes_buf(24);

    // Generating and encrypting the cursor
    const paginatedResult = getPaginatedResult(params, limit, result);
    const encryptedCursor = await sodium.crypto_secretbox(paginatedResult.meta.cursor, nonce, key);
    const base64EncryptedCursor = encryptedCursor.toString('base64')

    // Decrypting and decoding the cursor
    const decryptedCursor = await sodium.crypto_secretbox_open(Buffer.from(base64EncryptedCursor, 'base64'), nonce, key);

    const decodedCursor = decodeCursor(decryptedCursor.toString());

    console.log('DynamoDB Query Parameters', decodedCursor)
})();
```

# API Reference

## Functions

<dl>
<dt><a href="#getPaginatedResult">getPaginatedResult(params, limit, result)</a> ⇒ <code>PaginatedResult&lt;T&gt;</code></dt>
<dd></dd>
<dt><a href="#decodeCursor">decodeCursor(cursor)</a> ⇒ <code>DynamoDBParams</code> | <code>undefined</code></dt>
<dd></dd>
</dl>

## Typedefs

<dl>
<dt><a href="#DynamoDBParams">DynamoDBParams</a> : <code>Object</code></dt>
<dd></dd>
<dt><a href="#DynamoDBResult">DynamoDBResult</a> : <code>Object</code></dt>
<dd></dd>
<dt><a href="#MetaData">MetaData</a> : <code>Object</code></dt>
<dd></dd>
<dt><a href="#PaginatedResult">PaginatedResult</a> : <code>Object</code></dt>
<dd></dd>
<dt><a href="#Cursor">Cursor</a> : <code>Object</code></dt>
<dd></dd>
</dl>

<a name="getPaginatedResult"></a>

## getPaginatedResult(params, limit, result) ⇒ <code>PaginatedResult&lt;T&gt;</code>
**Kind**: function

| Param | Type |
| --- | --- |
| params | [<code>DynamoDBParams</code>](#DynamoDBParams) |
| limit | <code>number</code> |
| result | [<code>DynamoDBResult</code>](#DynamoDBResult) |

<a name="decodeCursor"></a>

## decodeCursor(cursor) ⇒ <code>Cursor</code> \| <code>undefined</code>
**Kind**: function

| Param | Type |
| --- | --- |
| encodedCursor| <code>string</code> |

<a name="DynamoDBParams"></a>

## DynamoDBParams : <code>Object</code>
**Kind**: object
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| TableName | <code>string</code> | The name of the table containing the requested items |
| [IndexName] | <code>string</code> | The name of a secondary index to scan |
| [AttributesToGet] | <code>any</code> | This is a legacy parameter. Use ProjectionExpression instead. |
| [Limit] | <code>number</code> | The maximum number of items to evaluate |
| [Select] | <code>any</code> | The attributes to be returned in the result |
| [ScanFilter] | <code>any</code> | This is a legacy parameter |
| [ConditionalOperator] | <code>any</code> | This is a legacy parameter |
| [ExclusiveStartKey] | <code>any</code> | The primary key of the first item that this operation will evaluate |
| [ReturnConsumedCapacity] | <code>any</code> | Adds the consumed capacity to the result |
| [TotalSegments] | <code>any</code> | For a parallel Scan request |
| [Segment] | <code>any</code> | For a parallel Scan request |
| [ProjectionExpression] | <code>string</code> | A string that identifies one or more attributes to retrieve from the specified table or index |
| [FilterExpression] | <code>string</code> | A string that contains conditions that DynamoDB applies after the Scan operation |
| [ExpressionAttributeNames] | <code>any</code> | One or more substitution tokens for attribute names in an expression |
| [ExpressionAttributeValues] | <code>any</code> | One or more values that can be substituted in an expression |
| [ConsistentRead] | <code>boolean</code> | A Boolean value that determines the read consistency model during the scan |

<a name="DynamoDBResult"></a>

## DynamoDBResult : <code>Object</code>
**Kind**: object
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| [Items] | <code>any</code> | An array of item attributes that match the scan criteria |
| [Count] | <code>number</code> | The number of items in the response |
| [ScannedCount] | <code>number</code> | The number of items evaluated |
| [LastEvaluatedKey] | <code>any</code> | The primary key of the item where the operation stopped |
| [ConsumedCapacity] | <code>any</code> | The capacity units consumed by the Scan operation |

<a name="MetaData"></a>

## MetaData : <code>Object</code>
**Kind**: object
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| limit | <code>number</code> | The limit of the amount of returned items |
| hasMoreData | <code>boolean</code> | True if not all items in the DynamoDB table were returned that match the query |
| cursor | <code>string</code> | Used for pagination if there are more items left |
| backCursor | <code>string</code> | Used for paginating back to previous results |
| count | <code>number</code> | The amount of items returned |

<a name="PaginatedResult"></a>

## PaginatedResult : <code>Object</code>
**Kind**: object
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| data | <code>T</code> | The queried data |
| meta | [<code>MetaData</code>](#MetaData) | Metadata regarding the result |

## Cursor: <code>Object</code>
**Kind**: object
**Properties**

| Name | Type | Description |
| --- | --- | --- |
| ExclusiveStartKey | <code>any</code> | Start key for navigating DynamoDB queries |
| previousKeys | <code>any[]</code> | Previous used ExclusiveStartKeys to navigate back to |
| back | <code>boolean</code> | To indicate wether it's a cursor used for forward or backwards navigation |

<a name="Cursor"></a>
